<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8'>

<title>test-master &mdash; Pike/master-ball @ GitHub</title>

<style type="text/css">
body {
	margin-top: 1.0em;
	background-color: #ffffff;
	font-family: Helvetica, Arial, FreeSans, san-serif;
	color: #000000;
}

#container {
	margin: 0 auto;
	width: 700px;
}

h1 {
	font-size: 3.8em;
	color: #000000;
	margin-bottom: 3px;
}

h1 .small {
	font-size: 0.4em;
}

h1 a {
	text-decoration: none
}

h2 {
	font-size: 1.5em;
	color: #000000;
}

h3 {
	text-align: center;
	color: #000000;
}

a {
	color: #000000;
}

.description {
	font-size: 1.2em;
	margin-bottom: 30px;
	margin-top: 30px;
	font-style: italic;
}

.download {
	float: right;
}

pre {
	background: #000;
	color: #fff;
	padding: 15px;
}

hr {
	border: 0;
	width: 80%;
	border-bottom: 1px solid #aaa
}

.footer {
	text-align: center;
	padding-top: 30px;
	font-style: italic;
}

.note {
	background-color: #ccc;
	border-left: 3px solid #aaa;
	padding: 1em;
	margin: 2em 0em 2em 1em;
}
</style>
<!-- content styles to locate and disambiguate shell commands -->
<style type="text/css">
code.no-env.master-ball:before {
	content: "master-ball$ ";
	color: #CCCCCC;
}

code.no-env.a10n:before {
	content: "a10n$ ";
	color: #CCCCCC;
}

code.no-env.stage:before {
	content: "stage$ ";
	color: #CCCCCC;
}

code.env.stage:before {
	content: "(env) stage$ ";
	color: #CCCCCC;
}

code.env.stage-ab:before {
	content: "(env) ab$ ";
	color: #CCCCCC;
}

code.elmo:before {
	content: "(@elmo) elmo$ ";
	color: #CCCCCC;
}

code.env.test-master:before {
	content: "(@master) test-master$ ";
	color: #CCCCCC;
}

code.env.master-ball:before {
	content: "(@master) master-ball$ ";
	color: #CCCCCC;
}

code.env.a10n:before {
	content: "(env) a10n$ ";
	color: #CCCCCC;
}

code.env.slave-ball:before {
	content: "(@slave) slave-ball$ ";
	color: #CCCCCC;
}
</style>
</head>

<body>
  <a href="http://github.com/Pike/master-ball"><img
    style="position: absolute; top: 0; right: 0; border: 0;"
    src="http://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"
    alt="Fork me on GitHub" /></a>

  <div id="container">

    <h1>test-master</h1>

    <div class="description">
      <em>test-master</em> is a local-only test setup for the elmo build
      infrastructure.
    </div>

    <h2>Take-Aways</h2>
    <p>This document is a follow-up to the <a href="http://pike.github.io/a10n/test-setup/">a10n test setup</a>.
    You'll see how to:</p>
    <ul>
      <li>Configure <code>master-ball/test-master</code></li>
      <li>Set up the master</li>
      <li>Set up the slave</li>
      <li>Run the bots</li>
      <li>Watch the results</li>
    </ul>

    <div class="note">
      <p>There are going to be several shell terminals and
      virtualenvs throughout this page. In each command, the shell prompt
      indicates the activated virtualenv, if so, and the directory you should be
      in. That is, a</p>
      <pre><code class="env master-ball">ls</code></pre>
      <p>is a <code>ls</code> in the <code>master-ball</code> directory with the
      <code>@master</code> virtualenv activated.</p>
    </div>

    <h2 id="requirements">Requirements</h2>
    <p>All the requirements to set up <code>test-master</code> should
    already be there once you've set up the a10n test environment.</p>

    <h2 id="configure">Install and Configure test-master</h2>
    <p>
      For the general master setup, you want to follow the instructions
      for l10n-master, but you'll put your local.py into the
      <code>test-master</code>
      directory.
    </p>
    <p>
      Your
      <code>test-master/local.py</code>
      should look somewhat like this:
    </p>
    <pre>from base_settings import *
DATABASES = {
    'default': {} # you know this stuff
}
REPOSITORY_BASE = '/my/home/stage/repos/'
buildbase = '/my/home/stage/builds/'
ES_COMPARE_HOST = 'localhost:9200'
ES_COMPARE_INDEX = 'elmo-comparisons'

SECRET_KEY = 'Do Not Tell Me'
</pre>
    <p>
      The
      <code>REPOSITORY_BASE</code>
      points to the
      <code>repos</code>
      subdirectory in your test environment, and
      <code>buildbase</code>
      is where buildbot will store logs and other build data. We'll use
      the same directories when in
      <code>settings/mounts_local.py</code>
      when setting up elmo.
    </p>

    <h2>Master setup</h2>
    <p>As you're in a new shell now, and we'll want to create a virtualenv
    for master now..</p>
    <pre><code class="no-env master-ball">virtualenv @master</code>
<code class="no-env master-ball">. @master/bin/activate</code>
<code class="env master-ball">pip install -r requirements.txt</code></pre>
    <p>
      For the stuff that follows, you should generally have that on.
      You'll see by the
      <code>(@master)</code>
      prefix in the code snippets which lines are in the env for sure.
    </p>
    <p>
      We're working in
      <code>test-master</code>
      , so let's go there, and create the master.
    </p>
    <pre><code class="env master-ball">cd test-master</code>
<code class="env test-master">../scripts/buildbot create-master .</code></pre>
    <p>
      You only need to do that once. Next we need the
      <code>local.py</code>
      with the following contents, plus your common database setup:
    </p>
    <pre>from base_settings import *
DATABASES = {
    'default': {} # you know this stuff
}
REPOSITORY_BASE = '/my/home/stage/repos/'
buildbase = '/my/home/stage/builds/

SECRET_KEY = 'Do Not Tell Me'</pre>
    <p>
      That's all. Next you want to set up a buildbot slave, with
      <code>slave-ball</code>.
      You want to set that up with name and password from
      <code>slaves.json</code>.
    </p>

    <h3 id="es-index">Elasticsearch Index</h3>
    <p>You need to have an elasticsearch instance running. The documentation
    here assumes that you're running it on `localhost` and the standard
    `9200` port.</p>
    <p>For the initial setup, you need to create an <em>Index</em>, where
    elasticsearch (ES in short) stores its data.</p>
    <p>To do so, head over to your <code>elmo</code> install, activate the
    virtualenv there, and run</p>
    <pre><code class="elmo">./manage.py createcompareindex</code></pre>

    <h3 id="slave-setup">Slave setup</h3>
    <p>The slave setup is the very same for <code>test-master</code> and
    <code>l10n-master</code>, so pick that up quickly from the <a
    href="../slave-ball">slave-ball</a> doc.</p>

    <h2>Running the bots</h2>
    <p class="note">
      The first time you run the bots, you may want to run the
      <code>get-pushes</code>
      daemon before the build bots. Usually, it's the last bot to start,
      though.<br> This is to get the initial push to
      <code>en-US</code>
      into the database without triggering a build for it, which is
      closer to what happens in reality.
    </p>
    <p>
      There are 8 services involved in running the dashboard, the
      <a href="#elmo">elmo webserver</a>, the <a
      href="#mercurial">mercurial web server</a>,
      <a href="#es">elasticsearch</a>, the buildbot
      <a href="#master">master</a> and <a href="#slave">slave</a>,
      <a href="#rabbitmq">rabbitmq</a>, <a href="#hg">a10n hg</a>, and the
      twistd <a href="#get-pushes">get-pushes</a>
      daemon. You always want to have your mercurial server up. Same goes for
      elasticsearch and rabbitmq. The elmo
      server can be up or not, it doesn't interfere with the other bots.
      It's just good to be there to check that the rest reports as
      expected. The four remaining bots and services are the actual build system,
      and the starting order of those has actual impact on what happens.
    </p>

    <h3 id="elmo">elmo</h3>
    <p>
      Often you want to run the elmo webserver, too. If
      you're using a virtualenv for elmo, use that. We'll assume the
      default port here and going forward, <code>8000</code>.
    </p>
    <pre><code class="elmo">./manage.py runserver</code></pre>

    <h3 id="rabbitmq">rabbitmq</h3>
    <p>On most systems, <code>rabbitmq</code> will be automatically run as
    part of the boot process.</p>

    <h3 id="es">elasticsearch</h3>
    <p>Find the installation path to elasticsearch, and run</p>
    <pre><code>./bin/elasticsearch</code></pre>

    <h3 id="mercurial">mercurial web server</h3>
    <p>Before you start the build automation, be sure that the
      mercurial webserver is running.</p>
    <pre><code class="env stage">hg serve --webdir-conf=webdir.conf -p 8001</code></pre>
    <p>The master and slave both need each other to get any work
      done. The order of startup isn't really important, as the slave
      continuously try to connect to the master. When they don't reach
      the master, they back up, though. The quickest startup time is to
      start the master first, and then the slave.</p>
    <h3 id="master">buildbot master</h3>
    <p>
      In the
      <code>master-ball</code>
      directory, do
    </p>
    <pre><code class="env master-ball">./scripts/buildbot start test-master</code>
<code class="env master-ball">tail -f test-master/twistd.log</code></pre>
    <p>
      where
      <code>test-master</code>
      is the path to the test-master directory, not the name or
      something else.
    </p>
    <p>You'll already see a bit of work in the log, as the master
      gets itself ready to get crackin'. But for the actual work, it
      needs the slave(s).</p>
    <h3 id="slave">buildbot slave</h3>
    <p>
      In the virtualenv of
      <code>slave-ball</code>
      and that directory, run
    </p>
    <pre><code class="env slave-ball">./scripts/buildbot start slave</code>
<code class="env slave-ball">tail -f slave/twistd.log</code></pre>
    <p>
      You want to make sure that the bots do the right thing up to here,
      in particular that the <a href="#master-started">startup
        builds are successful</a>.
    </p>
    <p>
      Next up is the combo of <code>a10n hg</code> and <code>get-pushes</code>.
      <code>get-pushes</code> is a daemon that polls the hg server, and adds
      information about new pushes into <code>rabbitmq</code>. That queue is
      worked through by <code>a10n hg</code>, which pulls the working repos,
      and fills in detailed information about new mercurial changesets into the
      <code>elmo</code> database. You probably want to do this <em>before</em>
      you start the buildbot master, just because it's more realistic to have
      repos first, and then builds.
    </p>

    <h3 id="hg">a10n hg</h3>
    <p>This is run in the <code>a10n</code> directory</p>
    <pre><code class="env a10n">./scripts/a10n hg</code></pre>

    <h3 id="get-pushes">get-pushes</h3>
    <p>This is also run in the <code>a10n</code> directory</p>

    <pre><code class="env a10n">twistd -n get-pushes</code></pre>
    <p>
      Now you're looking at the log file of the get-pushes daemon. If you're
      running it for the first time, you should find a push on
      <code>mozilla</code> , and then cycle every few seconds.
    </p>

    <h2>Watch the results</h2>
    <p>You should have 6 shells with logs for each part of the
      automation now:</p>
    <ol>
      <li>the django log for elmo</li>
      <li>the hg output of hg serve (noisy, that's cool)</li>
      <li>the tail of twistd.log for get-pushes (this makes hg
        noisy)</li>
      <li>the output of <code>a10n hg</code>, processing pushes as they come</li>
      <li>the tail of twistd.log for test-master</li>
      <li>the tail of twistd.log for the slave connected to
        test-master</li>
    </ol>

    <h3>Expectations on elmo</h3>
    <p>
      On elmo, the <a href="http://localhost:8000/">homepage</a> should
      show 4 active l10n repositories, and the pushes view over <a
        href="http://localhost:8000/source/pushes/">all repositories</a> should
      show one push on the
      <code>mozilla</code>
      repository.
    </p>
    <p id="master-started">
      Whenever you start the buildmaster, it will trigger a build per <em>tree</em>
      to get more data from the
      <code>l10n.ini</code>
      files on hg, and as you started all bots, you should see one build
      on the <a href="http://localhost:8000/builds/waterfall">waterfall</a>,
      for the <em>tree-builder</em> Builder. If that box isn't green,
      your setup is broken. From there, you get to the actual <a
        href="http://localhost:8000/builds/builders/tree-builder/0">build
        display</a>, showing one step
      <code>configured fx</code>
      . You should be able to surf to it's
      <code>stdio</code>
      log, and see the build properties. In particular the
      <code>locales</code>
      and
      <code>tree</code>
      build properties should match your setup.
    </p>

    <h2>Play</h2>
    <p>
      Next up is play. Let's be a localizer and push our changes. The
      staging script already pre-filled all working copies with data,
      which we can now just push. While we're doing that, watching the <a
        href="http://localhost:8000/builds/tbpl">TBPL</a> (bad name) is
      entertaining. (That page only refreshes every 5 minutes, tweak
      <code>delay</code>
      in a js shell for now.)
    </p>
    <p>
      Let's go to our working directories,
      <code>l10n/ab</code>
      for a start, and push. Be sure to have your virtualenv activated
      again.
    </p>
    <pre><code class="env stage">cd workdir/l10n/ab</code>
<code class="env stage-ab">hg push</code></pre>
    <p>That will tell you that it's inserting that changeset to the
      pushlog. That's the local one per repository that our mercurial
      hooks do.</p>
    <p>
      Next, the
      <code>get-pushes</code>
      daemon will find that, and add it to the overall elmo pushes
      database. You can verify that on the <a
        href="http://localhost:8000/source/pushes/">pushes</a> page.
    </p>
    <p>
      Then, the
      <code>test-master</code>
      will pick that up, and schedule a compare-locales build for it,
      which then runs and does the work on the slave.
    </p>
    <p>As the build starts (and when it's ended), it will show up on
      the build reporting page.</p>
    <p>
      Now that we have a real active tree, you'll see the
      <code>fx</code>
      tree show up on the <a href="http://localhost:8000/">homepage</a>,
      linking to the <a href="http://localhost:8000/dashboard/?tree=fx">dashboard</a>
      of the tree. Which gives us a chance to verify that the rich
      compare-locales output works as well, if you click on the
      <code>C</code>
      link there.
    </p>

    <h3>Next steps</h3>
    <p>
      Next up, you can push the remaining localizations, and also do an
      edit to the l10n files in
      <code>mozilla</code>
      , check that in and push, to see how the build system behaves if
      en-US changes. Tip: It should update all locales.
    </p>
    <p>If you just want to test build automation, you can fake changes, too.</p>
    <pre><code class="env master-ball">./scripts/buildbot sendchange --master=localhost:9876 -u me \
    --branch=l10n --property=locale:de browser/file.properties</code></pre>
    <p>The options for sendchange mean, resp.</p>
    <ul>
      <li>the port of the master, <code>localhost:9876</code></li>
      <li>your name, pick what you want</li>
      <li>the <code>branch</code>. For a standalone repository like
      <code>mozilla</code> this is <code>mozilla</code>. For l10n repositories,
      this is the parent. So for a change that affected <code>/l10n/de</code>
      you pass <code>l10n</code></li>
      <li>If this is an l10n repository, pass the leafname of the repo. I.e.,
      for a change to <code>/l10n/de</code> pass <code>locale:de</code>. The
      name and value of the property are separated by a colon.</li>
      <li>One or more files. Depending on the files you pass and
      <code>l10n.ini</code>, different builds will be triggered.</li>
    </ul>
    <p>Also visit the upstream documentation for
    <a href="http://docs.buildbot.net/0.7.12/#sendchange">sendchange</a>.</p>

    <h2>Shutting down</h2>
    <p>Enough learning, let's shut the bots down in a safe order:</p>
    <p>First, stop taking new pushes into our system, and kill</p>
    <dl>
      <dt>get-pushes</dt>
      <dd>If you're running it interactively, just <code>Crtl-C</code>. If
      you had it daemonize, you'll need to kill the process.
        <pre><code class="env a10n">kill `cat twistd.pid`</code></pre>
      </dd>
    </dl>
    <p>Make sure that master and slave are idle, i.e., the logs only show pings,
    and then stop master and slave. The order doesn't matter much at this
    point.</p>
    <dl>
      <dt>slave</dt>
      <dd>
        <pre><code class="env slave-ball">./scripts/buildbot stop slave</code></pre>
      </dd>
      <dt>master</dt>
      <dd>
        <pre><code class="env master-ball">./scripts/buildbot stop test-master</code></pre>
      </dd>
    </dl>

  </div>
</body>
</html>
